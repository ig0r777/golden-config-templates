{#
  Juniper Class of Service (CoS) Configuration Template
  
  This template implements a comprehensive QoS configuration following
  the ASLAN organizational standard for traffic prioritization.
  
  Variables:
  - cos_enable: Enable CoS configuration (default: true)
  - cos_profile: CoS profile name (default: "ASLAN")
  - host_outbound_class: Forwarding class for host-outbound traffic (default: "NC")
  - host_outbound_dscp: DSCP code point for host-outbound traffic (default: "110000")
  
  Traffic Classes (Priority Order):
  1. NC (Network Control) - Queue 5 - 5% guaranteed
  2. EF (Expedited Forwarding) - Queue 4 - 20% shaped, strict-high priority
  3. dscp15 (Custom) - Queue 4 - Shares EF scheduler
  4. AF41 (Assured Forwarding) - Queue 3 - 15% shaped
  5. AF31 (Assured Forwarding) - Queue 2 - 30% shaped
  6. Default - Queue 1 - 10% shaped
  7. BE (Best Effort) - Queue 0 - Remainder bandwidth
#}
{%- set cos_enable = cos_enable | default(true) -%}
{%- set cos_profile = cos_profile | default("ASLAN") -%}
{%- set host_outbound_class = host_outbound_class | default("NC") -%}
{%- set host_outbound_dscp = host_outbound_dscp | default("110000") -%}

{%- if cos_enable %}
set class-of-service classifiers dscp dscp-{{ cos_profile }}-v4 forwarding-class NC loss-priority low code-points 110000
set class-of-service classifiers dscp dscp-{{ cos_profile }}-v4 forwarding-class EF loss-priority high code-points [ 101000 100000 101001 101011 100001 100011 110001 101101 ]
set class-of-service classifiers dscp dscp-{{ cos_profile }}-v4 forwarding-class AF41 loss-priority high code-points [ 011000 101110 011100 011110 100110 ]
set class-of-service classifiers dscp dscp-{{ cos_profile }}-v4 forwarding-class AF31 loss-priority high code-points [ 001001 001011 010001 010011 011001 011011 010000 ]
set class-of-service classifiers dscp dscp-{{ cos_profile }}-v4 forwarding-class BE loss-priority high code-points 000000
set class-of-service classifiers dscp dscp-{{ cos_profile }}-v4 forwarding-class Default loss-priority high code-points 001000
set class-of-service classifiers dscp dscp-{{ cos_profile }}-v4 forwarding-class dscp15 loss-priority high code-points 001111
set class-of-service classifiers dscp-ipv6 dscp-{{ cos_profile }}-v6 forwarding-class NC loss-priority low code-points 110000
set class-of-service classifiers dscp-ipv6 dscp-{{ cos_profile }}-v6 forwarding-class EF loss-priority high code-points [ 101000 100000 101001 101011 100001 100011 110001 101101 ]
set class-of-service classifiers dscp-ipv6 dscp-{{ cos_profile }}-v6 forwarding-class AF41 loss-priority high code-points [ 011000 101110 011100 011110 100110 ]
set class-of-service classifiers dscp-ipv6 dscp-{{ cos_profile }}-v6 forwarding-class AF31 loss-priority high code-points [ 001001 001011 010001 010011 011001 011011 010000 ]
set class-of-service classifiers dscp-ipv6 dscp-{{ cos_profile }}-v6 forwarding-class BE loss-priority high code-points 000000
set class-of-service classifiers dscp-ipv6 dscp-{{ cos_profile }}-v6 forwarding-class Default loss-priority high code-points 001000
set class-of-service classifiers dscp-ipv6 dscp-{{ cos_profile }}-v6 forwarding-class dscp15 loss-priority high code-points 001111
set class-of-service host-outbound-traffic forwarding-class {{ host_outbound_class }}
set class-of-service host-outbound-traffic dscp-code-point {{ host_outbound_dscp }}
set class-of-service forwarding-classes class NC queue-num 5
set class-of-service forwarding-classes class AF41 queue-num 3
set class-of-service forwarding-classes class AF31 queue-num 2
set class-of-service forwarding-classes class Default queue-num 1
set class-of-service forwarding-classes class BE queue-num 0
set class-of-service forwarding-classes class dscp15 queue-num 4
set class-of-service forwarding-classes class EF queue-num 4
set class-of-service interfaces ge-* unit 0 classifiers dscp dscp-{{ cos_profile }}-v4
set class-of-service interfaces xe-* unit 0 classifiers dscp dscp-{{ cos_profile }}-v4
set class-of-service rewrite-rules dscp dscp15-45 forwarding-class dscp15 loss-priority high code-point 101101
set class-of-service rewrite-rules dscp dscp15-45 forwarding-class NC loss-priority low code-point 110000
set class-of-service rewrite-rules dscp dscp15-45 forwarding-class EF loss-priority high code-point 110001
set class-of-service rewrite-rules dscp dscp15-45 forwarding-class AF41 loss-priority high code-point 100110
set class-of-service rewrite-rules dscp dscp15-45 forwarding-class AF31 loss-priority high code-point 010000
set class-of-service rewrite-rules dscp dscp15-45 forwarding-class BE loss-priority high code-point 000000
set class-of-service rewrite-rules dscp dscp15-45 forwarding-class Default loss-priority high code-point 001000
set class-of-service rewrite-rules dscp-ipv6 dscp15-45 forwarding-class dscp15 loss-priority high code-point 101101
set class-of-service rewrite-rules dscp-ipv6 dscp15-45 forwarding-class NC loss-priority low code-point 110000
set class-of-service rewrite-rules dscp-ipv6 dscp15-45 forwarding-class EF loss-priority high code-point 110001
set class-of-service rewrite-rules dscp-ipv6 dscp15-45 forwarding-class AF41 loss-priority high code-point 100110
set class-of-service rewrite-rules dscp-ipv6 dscp15-45 forwarding-class AF31 loss-priority high code-point 010000
set class-of-service rewrite-rules dscp-ipv6 dscp15-45 forwarding-class BE loss-priority high code-point 000000
set class-of-service rewrite-rules dscp-ipv6 dscp15-45 forwarding-class Default loss-priority high code-point 001000
set class-of-service scheduler-maps map-{{ cos_profile }} forwarding-class NC scheduler NC
set class-of-service scheduler-maps map-{{ cos_profile }} forwarding-class EF scheduler EF
set class-of-service scheduler-maps map-{{ cos_profile }} forwarding-class AF41 scheduler AF41
set class-of-service scheduler-maps map-{{ cos_profile }} forwarding-class AF31 scheduler AF31
set class-of-service scheduler-maps map-{{ cos_profile }} forwarding-class BE scheduler BE
set class-of-service scheduler-maps map-{{ cos_profile }} forwarding-class Default scheduler Default
set class-of-service scheduler-maps map-{{ cos_profile }} forwarding-class dscp15 scheduler AF41
set class-of-service schedulers NC transmit-rate percent 5
set class-of-service schedulers EF shaping-rate percent 20
set class-of-service schedulers EF priority strict-high
set class-of-service schedulers AF41 shaping-rate percent 15
set class-of-service schedulers AF41 buffer-size percent 12
set class-of-service schedulers AF41 priority low
set class-of-service schedulers AF31 shaping-rate percent 30
set class-of-service schedulers AF31 buffer-size percent 30
set class-of-service schedulers AF31 priority low
set class-of-service schedulers BE transmit-rate remainder
set class-of-service schedulers BE buffer-size remainder
set class-of-service schedulers BE priority low
set class-of-service schedulers Default shaping-rate percent 10
set class-of-service schedulers Default buffer-size percent 10
set class-of-service schedulers Default priority low
{%- endif %}
